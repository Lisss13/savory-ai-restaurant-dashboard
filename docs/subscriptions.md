# Задание: Реализация функционала подписок в панели пользователя

## Контекст

Реализовать в панели администратора организации раздел для работы с подписками:
- Просмотр текущей подписки
- Создание заявки на продление
- Просмотр истории заявок

## API Документация

**ВАЖНО:** Все API endpoints, модели данных, форматы запросов и ответов необходимо брать из файла `docs/swagger.yaml`.

Файл swagger.yaml является единственным источником правды для API. Используй его для:
- Получения списка всех endpoints
- Генерации TypeScript типов из схем
- Понимания форматов request/response
- Валидации данных

### Как использовать swagger.yaml

1. **Просмотр документации:**
    - Открой файл `docs/swagger.yaml`
    - Или используй Swagger UI для визуализации

2. **Генерация типов:**
    - Можно использовать `openapi-typescript` для автоматической генерации TypeScript типов
    - Команда: `npx openapi-typescript docs/swagger.yaml -o src/api/types.ts`

3. **Релевантные секции в swagger.yaml:**
    - Paths: `/subscriptions/*` и `/subscriptions/extension-requests/*`
    - Schemas: `SubscriptionResponse`, `ExtensionRequestResponse`, `CreateExtensionRequestRequest`, `UpdateExtensionRequestStatusRequest`

### Основные endpoints (справочно)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/subscriptions/organization/:id/active` | Активная подписка |
| GET | `/subscriptions/extension-requests/my` | Мои заявки на продление |
| POST | `/subscriptions/extension-requests` | Создать заявку |
| GET | `/subscriptions/extension-requests/:id` | Заявка по ID |

**Полный список endpoints и схемы данных смотри в `docs/swagger.yaml`**

## Требования к реализации

### 1. Страница "Подписка" (`/subscription`)

#### 1.1 Карточка текущей подписки

Отображать информацию об активной подписке:

```
+--------------------------------------------------+
|  Ваша подписка                                   |
+--------------------------------------------------+
|  Статус: [Активна] / [Истекла] / [Нет подписки]  |
|                                                  |
|  Период: 1 месяц                                 |
|  Дата начала: 01.12.2025                         |
|  Дата окончания: 01.01.2026                      |
|                                                  |
|  Осталось: 25 дней                               |
|  [====================----] 80%                  |
|                                                  |
|  [Запросить продление]                           |
+--------------------------------------------------+
```

**Логика отображения статуса:**
- `isActive && daysLeft > 0` → "Активна" (зеленый)
- `isActive && daysLeft === 0` → "Истекла" (красный)
- `!isActive` → "Деактивирована" (серый)
- Нет подписки → "Нет активной подписки"

**Progress bar:**
- Вычислять процент: `((period * 30) - daysLeft) / (period * 30) * 100`

#### 1.2 Предупреждения

| Условие | UI |
|---------|-----|
| `daysLeft <= 7` | Красный баннер "Подписка истекает через X дней!" |
| `daysLeft <= 14` | Желтый баннер "Подписка скоро истечет" |
| `daysLeft === 0` | Красный баннер "Подписка истекла!" |

#### 1.3 Глобальное предупреждение в Header

При `daysLeft <= 7` показывать в шапке приложения:
```
[!] Ваша подписка истекает через 5 дней [Продлить]
```

### 2. Модальное окно "Запрос на продление"

При нажатии кнопки "Запросить продление" открывать форму:

```
+--------------------------------------------------+
|  Запрос на продление подписки              [X]   |
+--------------------------------------------------+
|                                                  |
|  Имя *                                           |
|  [________________________]                      |
|                                                  |
|  Телефон *                                       |
|  [________________________]                      |
|                                                  |
|  Email *                                         |
|  [________________________]                      |
|                                                  |
|  Желаемый период продления                       |
|  [1 месяц    v]                                  |
|                                                  |
|  Комментарий                                     |
|  [________________________]                      |
|  [________________________]                      |
|                                                  |
|  [Отмена]              [Отправить запрос]        |
+--------------------------------------------------+
```

**Валидация:**
- `name` — обязательное, минимум 2 символа
- `phone` — обязательное, формат телефона
- `email` — обязательное, валидный email
- `period` — опционально, положительное число

**После отправки:**
1. Показать сообщение "Заявка успешно отправлена"
2. Закрыть модальное окно
3. Обновить список заявок

### 3. Список заявок на продление

Отображать таблицу с историей заявок:

```
+--------------------------------------------------+
|  Мои заявки на продление                         |
+--------------------------------------------------+
| Дата       | Период | Статус      | Комментарий  |
|------------|--------|-------------|--------------|
| 01.12.2025 | 3 мес. | В ожидании  | -            |
| 15.11.2025 | 1 мес. | Одобрена    | Оплата...    |
| 01.10.2025 | 6 мес. | Отклонена   | Недостаточно |
+--------------------------------------------------+
```

**Статусы заявок:**
- `pending` — "В ожидании" (желтый)
- `approved` — "Одобрена" (зеленый)
- `rejected` — "Отклонена" (красный)
- `completed` — "Завершена" (серый)

**При клике на строку** — открывать детали заявки.

### 4. Детали заявки (модальное окно или отдельный блок)

```
+--------------------------------------------------+
|  Заявка #123                               [X]   |
+--------------------------------------------------+
|  Дата создания: 01.12.2025 14:30                 |
|  Статус: В ожидании                              |
|                                                  |
|  Контактные данные:                              |
|  - Имя: Иван Иванов                              |
|  - Телефон: +7 900 123-45-67                     |
|  - Email: ivan@example.com                       |
|                                                  |
|  Желаемый период: 3 месяца                       |
|  Комментарий: Хотим продлить подписку            |
|                                                  |
|  Ответ администратора:                           |
|  [Пока нет ответа]                               |
+--------------------------------------------------+
```

## Интеграция в навигацию

Добавить пункт в боковое меню:
```
- Дашборд
- Рестораны
- Меню
- Столики
- Бронирования
- Подписка        <-- новый пункт
- Настройки
```

## Хранение состояния

Рекомендуемая структура store:

```typescript
interface SubscriptionState {
  // Текущая подписка
  currentSubscription: Subscription | null;
  subscriptionLoading: boolean;
  subscriptionError: string | null;

  // Заявки на продление
  extensionRequests: ExtensionRequest[];
  requestsLoading: boolean;
  requestsError: string | null;

  // Создание заявки
  createRequestLoading: boolean;
  createRequestError: string | null;
}
```

## Работа с API

**Все детали API смотри в `docs/swagger.yaml`**

### Формат ответа API

Все ответы сервера имеют единую структуру:
```json
{
  "data": { },
  "messages": ["success"],
  "code": 200
}
```

Данные всегда находятся в поле `response.data`.

### Авторизация

Все защищённые endpoints требуют JWT токен в заголовке:
```
Authorization: Bearer {token}
```

## Обработка ошибок

| Код | Действие |
|-----|----------|
| 401 | Редирект на страницу логина |
| 400 | Показать ошибку валидации из `messages` |
| 404 | "Подписка не найдена" / "Заявка не найдена" |
| 500 | "Ошибка сервера. Попробуйте позже" |

## Критерии приемки

1. [ ] Отображается информация о текущей подписке
2. [ ] Показывается количество оставшихся дней с progress bar
3. [ ] Отображаются предупреждения при `daysLeft <= 7` и `daysLeft <= 14`
4. [ ] Работает форма создания заявки на продление
5. [ ] Валидация формы работает корректно
6. [ ] Отображается список заявок с корректными статусами
7. [ ] Можно просмотреть детали заявки
8. [ ] Глобальное предупреждение в шапке при `daysLeft <= 7`
9. [ ] Корректная обработка ошибок API
10. [ ] Адаптивная верстка (mobile/desktop)
